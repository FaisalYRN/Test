import { useState } from "react";

const policies = [
  {
    id: 1,
    name: "Quality Assurance",
    type: "Fixed hours",
    linked: "2 presets",
    rules: {
      earlyClockIn: "30 min",
      gracePeriod: "15 min",
      lateClockOut: "30 min",
      locationTolerance: "5 min",
      missedClockOut: true,
      autoOvertime: null,
      breakDuration: "30 min",
      forceBreak: null,
    },
  },
  {
    id: 2,
    name: "Compliance Department",
    type: "Fixed hours",
    linked: "3 assigned presets",
    rules: {
      earlyClockIn: "30 min",
      gracePeriod: "15 min",
      lateClockOut: "30 min",
      locationTolerance: "5 min",
      missedClockOut: true,
      autoOvertime: "Max: 60 min",
      breakDuration: "30 min",
      forceBreak: "12:00pm - 01:00pm",
    },
  },
  {
    id: 3,
    name: "Policy Management",
    type: "Fixed hours",
    linked: null,
    rules: {
      earlyClockIn: "30 min",
      gracePeriod: "15 min",
      lateClockOut: "30 min",
      locationTolerance: "5 min",
      missedClockOut: false,
      autoOvertime: null,
      breakDuration: "30 min",
      forceBreak: "12:00pm - 01:00pm",
    },
  },
  {
    id: 4,
    name: "Regulatory Affairs",
    type: "Fixed hours",
    linked: "1 assigned preset",
    rules: {
      earlyClockIn: "30 min",
      gracePeriod: "15 min",
      lateClockOut: "30 min",
      locationTolerance: "5 min",
      missedClockOut: true,
      autoOvertime: "Max: 60 min",
      breakDuration: "30 min",
      forceBreak: null,
    },
  },
  {
    id: 5,
    name: "Engineering",
    type: "Flexible hours",
    linked: "4 presets",
    rules: {
      autoOvertime: "Max: 90 min",
      locationTolerance: "10 min",
    },
  },
  {
    id: 6,
    name: "Design",
    type: "Flexible hours",
    linked: "2 presets",
    rules: {
      autoOvertime: "Max: 60 min",
      locationTolerance: "5 min",
    },
  },
];

const ruleLabels = {
  earlyClockIn: "Early Clock In period",
  gracePeriod: "Grace Period",
  lateClockOut: "Late Clock Out period",
  locationTolerance: "Outside Location Tolerance",
  missedClockOut: "Missed clock-out deduction",
  autoOvertime: "Automatic overtime",
  breakDuration: "Break duration",
  forceBreak: "Force break window",
};

const ChevronIcon = ({ open }) => (
  <svg
    width="16"
    height="16"
    viewBox="0 0 16 16"
    fill="none"
    style={{
      transform: open ? "rotate(180deg)" : "rotate(0deg)",
      transition: "transform 0.2s ease",
    }}
  >
    <path
      d="M4 6L8 10L12 6"
      stroke="#999"
      strokeWidth="1.5"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </svg>
);

const DotsIcon = () => (
  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
    <circle cx="4" cy="8" r="1.2" fill="#999" />
    <circle cx="8" cy="8" r="1.2" fill="#999" />
    <circle cx="12" cy="8" r="1.2" fill="#999" />
  </svg>
);

const formatValue = (key, val) => {
  if (key === "missedClockOut") return val ? "Applied" : "Off";
  if (val === null) return "Off";
  return val;
};

const isActive = (key, val) => {
  if (key === "missedClockOut") return val === true;
  return val !== null;
};

const isNonDefault = (key, val) => {
  const defaults = {
    earlyClockIn: "30 min",
    gracePeriod: "15 min",
    lateClockOut: "30 min",
    locationTolerance: "5 min",
    missedClockOut: true,
    autoOvertime: null,
    breakDuration: "30 min",
    forceBreak: null,
  };
  return val !== defaults[key];
};

const PolicyRow = ({ policy, isExpanded, onToggle }) => {
  const activeCount = Object.entries(policy.rules).filter(([k, v]) =>
    isActive(k, v)
  ).length;
  const totalRules = Object.keys(policy.rules).length;

  return (
    <div
      style={{
        borderBottom: "1px solid #f0f0f0",
        background: isExpanded ? "#fafafa" : "#fff",
        transition: "background 0.15s ease",
      }}
    >
      {/* Main row */}
      <div
        onClick={onToggle}
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 100px 140px 80px 40px 32px",
          alignItems: "center",
          padding: "14px 20px",
          cursor: "pointer",
          gap: "12px",
        }}
      >
        {/* Name + type */}
        <div style={{ display: "flex", alignItems: "center", gap: "10px" }}>
          <span style={{ fontWeight: 600, fontSize: "14px", color: "#1a1a1a" }}>
            {policy.name}
          </span>
          <span
            style={{
              fontSize: "11px",
              fontWeight: 600,
              padding: "2px 8px",
              borderRadius: "4px",
              background:
                policy.type === "Fixed hours" ? "#FFF3E8" : "#E8F4FF",
              color: policy.type === "Fixed hours" ? "#E8600A" : "#0A6EE8",
            }}
          >
            {policy.type}
          </span>
        </div>

        {/* Active rules count */}
        <div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
          <span
            style={{ fontSize: "13px", fontWeight: 600, color: "#1a1a1a" }}
          >
            {activeCount}/8
          </span>
          <span style={{ fontSize: "12px", color: "#999" }}>active</span>
        </div>

        {/* Linked info */}
        <div style={{ fontSize: "12px", color: "#999" }}>
          {policy.linked ? (
            <span>{policy.linked}</span>
          ) : (
            <span style={{ color: "#ccc" }}>Not linked</span>
          )}
        </div>

        <div></div>

        {/* Expand */}
        <ChevronIcon open={isExpanded} />

        {/* Menu */}
        <div
          onClick={(e) => e.stopPropagation()}
          style={{
            cursor: "pointer",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
          }}
        >
          <DotsIcon />
        </div>
      </div>

      {/* Expanded detail */}
      {isExpanded && (
        <div
          style={{
            padding: "0 20px 16px 20px",
          }}
        >
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "repeat(4, 1fr)",
              gap: "8px",
            }}
          >
            {Object.entries(policy.rules).map(([key, val]) => {
              const active = isActive(key, val);
              const custom = isNonDefault(key, val);
              return (
                <div
                  key={key}
                  style={{
                    padding: "10px 12px",
                    borderRadius: "8px",
                    background: active ? "#fff" : "#fafafa",
                    border: "1px solid #f0f0f0",
                    opacity: active ? 1 : 0.5,
                  }}
                >
                  <div
                    style={{ fontSize: "11px", color: "#999", marginBottom: 4 }}
                  >
                    {ruleLabels[key]}
                  </div>
                  <div
                    style={{
                      fontSize: "14px",
                      fontWeight: 600,
                      color: active ? "#1a1a1a" : "#ccc",
                      display: "flex",
                      alignItems: "center",
                      gap: "6px",
                    }}
                  >
                    {key === "missedClockOut" && val && (
                      <span style={{ color: "#22c55e", fontSize: "14px" }}>
                        ●
                      </span>
                    )}
                    {formatValue(key, val)}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};

export default function AdherencePolicy() {
  const [expanded, setExpanded] = useState(null);
  const [tab, setTab] = useState("Fixed hours");
  const [search, setSearch] = useState("");

  const filtered = policies.filter(
    (p) =>
      p.type === tab &&
      p.name.toLowerCase().includes(search.toLowerCase())
  );

  return (
    <div
      style={{
        fontFamily:
          '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        maxWidth: 820,
        margin: "0 auto",
        padding: "24px",
      }}
    >
      {/* Header */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "flex-start",
          marginBottom: 24,
        }}
      >
        <div>
          <h1
            style={{
              fontSize: "22px",
              fontWeight: 700,
              margin: 0,
              color: "#1a1a1a",
            }}
          >
            Adherence Policy
          </h1>
          <p style={{ fontSize: "13px", color: "#999", margin: "4px 0 0" }}>
            Create individual shift rules with specific times, duration, and
            Adherence Policies.
          </p>
        </div>
        <button
          style={{
            background: "#E8600A",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            padding: "10px 20px",
            fontSize: "14px",
            fontWeight: 600,
            cursor: "pointer",
            display: "flex",
            alignItems: "center",
            gap: "6px",
          }}
        >
          + New policy
        </button>
      </div>

      {/* Controls */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 16,
        }}
      >
        <div
          style={{
            position: "relative",
            width: 260,
          }}
        >
          <span
            style={{
              position: "absolute",
              left: 12,
              top: "50%",
              transform: "translateY(-50%)",
              color: "#999",
              fontSize: "14px",
            }}
          >
            ⌕
          </span>
          <input
            type="text"
            placeholder="Search preset"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            style={{
              width: "100%",
              padding: "9px 12px 9px 32px",
              border: "1px solid #e5e5e5",
              borderRadius: "8px",
              fontSize: "13px",
              outline: "none",
              boxSizing: "border-box",
            }}
          />
        </div>

        <div
          style={{
            display: "flex",
            border: "1px solid #e5e5e5",
            borderRadius: "8px",
            overflow: "hidden",
          }}
        >
          {["Fixed hours", "Flexible hours"].map((t) => (
            <button
              key={t}
              onClick={() => setTab(t)}
              style={{
                padding: "8px 16px",
                fontSize: "13px",
                fontWeight: 500,
                border: "none",
                cursor: "pointer",
                background: tab === t ? "#1a1a1a" : "#fff",
                color: tab === t ? "#fff" : "#666",
                transition: "all 0.15s ease",
              }}
            >
              {t}
            </button>
          ))}
        </div>
      </div>

      {/* Column headers */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 100px 140px 80px 40px 32px",
          padding: "8px 20px",
          fontSize: "11px",
          fontWeight: 600,
          color: "#999",
          textTransform: "uppercase",
          letterSpacing: "0.5px",
          gap: "12px",
        }}
      >
        <span>Policy</span>
        <span>Rules</span>
        <span>Linked</span>
        <span></span>
        <span></span>
        <span></span>
      </div>

      {/* List */}
      <div
        style={{
          border: "1px solid #f0f0f0",
          borderRadius: "12px",
          overflow: "hidden",
          background: "#fff",
        }}
      >
        {filtered.map((p) => (
          <PolicyRow
            key={p.id}
            policy={p}
            isExpanded={expanded === p.id}
            onToggle={() =>
              setExpanded(expanded === p.id ? null : p.id)
            }
          />
        ))}
        {filtered.length === 0 && (
          <div
            style={{
              padding: "40px",
              textAlign: "center",
              color: "#999",
              fontSize: "13px",
            }}
          >
            No policies found
          </div>
        )}
      </div>

      {/* Summary bar */}
      <div
        style={{
          display: "flex",
          gap: "16px",
          marginTop: 12,
          fontSize: "12px",
          color: "#999",
        }}
      >
        <span>{filtered.length} policies</span>
        <span>·</span>
        <span>
          {filtered.filter((p) => p.linked).length} linked
        </span>
      </div>
    </div>
  );
}
